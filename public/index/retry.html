<!DOCTYPE html>
<html lang="en" class="dark transition-colors duration-300">
<head>
  <!-- Respect saved theme before paint -->
  <script>
    if (localStorage.getItem("theme") === "dark") {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Try Again ‚Äî Vaiform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' }; </script>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 font-sans min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-6">
        <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">
          <a href="/">Vaiform</a>
        </h1>
        <nav class="space-x-4 text-sm font-medium text-gray-600 dark:text-gray-300">
          <a href="/" class="hover:text-indigo-600 dark:hover:text-indigo-400">Home</a>
          <a href="/my-images.html" class="hover:text-indigo-600 dark:hover:text-indigo-400">My Images</a>
          <a href="/buy-credits.html" class="hover:text-indigo-600 dark:hover:text-indigo-400">Buy Credits</a>
        </nav>
      </div>
      <div class="flex items-center gap-4">
        <div id="credit-display" class="text-sm text-gray-600 dark:text-gray-300 hidden">
          Credits: <span id="credit-count">--</span>
        </div>
        <button id="theme-toggle" class="text-yellow-400 hover:text-yellow-300 text-xl" title="Toggle theme">üåô</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 w-full max-w-md mx-auto px-4 py-10">
    <div class="rounded-2xl p-6 sm:p-8 bg-white dark:bg-gray-800 shadow">
      <h2 class="text-2xl font-bold text-center mb-6">Try a New Prompt</h2>

      <form id="prompt-form" class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Email</label>
          <input id="email" type="email" disabled
                 class="w-full rounded-md border border-gray-300 dark:border-gray-600 p-2 bg-gray-100 dark:bg-gray-900" />
        </div>

        <div>
          <label class="block text-sm mb-1">Prompt</label>
          <input id="prompt" type="text" required
                 placeholder="Enter a new image prompt"
                 class="w-full rounded-md border border-gray-300 dark:border-gray-600 p-2 bg-white dark:bg-gray-900" />
        </div>

        <button type="submit" id="submit-btn"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg py-2.5 font-semibold transition">
          Generate New Image
        </button>
      </form>

      <p class="mt-4 text-xs text-gray-500 text-center">
        We‚Äôll queue a new generation using your current account credits.
      </p>
    </div>
  </main>

  <footer class="text-center text-sm text-gray-500 py-6 dark:text-gray-400">
    <a href="/" class="hover:underline">‚Üê Back to Home</a>
  </footer>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg text-sm hidden z-50"></div>

  <!-- Logic -->
  <script type="module">
    import { auth, db, BACKEND_URL } from "/js/config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Theme toggle
    const themeToggle = document.getElementById("theme-toggle");
    if (localStorage.getItem("theme") === "dark") {
      document.documentElement.classList.add("dark");
      themeToggle.textContent = "üåô";
    } else {
      document.documentElement.classList.remove("dark");
      themeToggle.textContent = "‚òÄÔ∏è";
    }
    themeToggle.addEventListener("click", () => {
      const isDark = document.documentElement.classList.toggle("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      themeToggle.textContent = isDark ? "üåô" : "‚òÄÔ∏è";
    });

    // Toast reader
    (function () {
      try {
        const msg = sessionStorage.getItem("vaiform_toast");
        if (!msg) return;
        const el = document.getElementById("toast");
        if (el) {
          el.textContent = msg;
          el.classList.remove("hidden");
          setTimeout(() => el.classList.add("hidden"), 2400);
        }
        sessionStorage.removeItem("vaiform_toast");
      } catch {}
    })();

    const creditDisplay = document.getElementById("credit-display");
    const creditCount = document.getElementById("credit-count");
    async function updateCredits(email) {
      try {
        const snap = await getDoc(doc(db, "users", email));
        if (snap.exists() && snap.data().credits != null) {
          creditCount.textContent = snap.data().credits;
          creditDisplay.classList.remove("hidden");
        }
      } catch {}
    }

    const emailInput = document.getElementById("email");
    const promptForm = document.getElementById("prompt-form");
    const promptInput = document.getElementById("prompt");
    const submitBtn = document.getElementById("submit-btn");
    const toastEl = document.getElementById("toast");

    function showToast(msg, ms = 2200) {
      if (!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.remove("hidden");
      setTimeout(() => toastEl.classList.add("hidden"), ms);
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        emailInput.value = user.email;
        updateCredits(user.email);
      } else {
        sessionStorage.setItem("vaiform_toast", "Please sign in first.");
        window.location.href = "/";
      }
    });

    promptForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();
      const prompt = promptInput.value.trim();
      if (!prompt) return;

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting‚Ä¶";

      try {
        const payload = {
          email,
          prompt,
          numImages: 1,
          upscale: false,
          style: "realistic",
          guidance: "",
          steps: "",
          seed: "",
          scheduler: "",
          refiner: ""
        };

        const res = await fetch(`${BACKEND_URL}/generate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) throw new Error(`Failed: ${res.status}`);

        sessionStorage.setItem("vaiform_toast", "‚úÖ New generation queued!");
        window.location.href = "/my-images.html";
      } catch (err) {
        console.error(err);
        showToast("‚ùå Error submitting your prompt.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Generate New Image";
      }
    });
  </script>
</body>
</html>