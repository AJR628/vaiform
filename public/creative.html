<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Studio - Vaiform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK - Load the same way as main site -->
    <script type="module" src="./js/config.js"></script>
    <!-- Auth bridge: expose auth & wire token provider before page code -->
    <script type="module" src="./auth-bridge.js"></script>
    <script type="module" src="./frontend.js"></script>
    <style>
        .loading { opacity: 0.6; pointer-events: none; }
        .error { color: #ef4444; }
        .success { color: #10b981; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">
    <!-- Navigation Header -->
    <header class="bg-gray-900 border-b border-gray-800">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <h1 class="text-2xl font-bold text-indigo-400">
                    <a href="/">Vaiform</a>
                </h1>
                <nav class="space-x-4 text-sm font-medium text-gray-300">
                    <a href="/" class="hover:text-indigo-400">Home</a>
                    <a href="/creative.html" class="text-indigo-400">Creative Studio</a>
                    <a href="/my-images.html" class="hover:text-indigo-400">My Images</a>
                    <a href="/buy-credits.html" class="hover:text-indigo-400">Buy Credits</a>
                </nav>
            </div>
            <div class="flex items-center gap-4">
                <div id="credit-display" class="text-sm text-gray-300 logged-in hidden">
                    Credits: <span id="credit-count">--</span>
                </div>
                <button id="login-button" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-sm logged-out hidden">Login</button>
                <button id="logout-button" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm logged-in hidden">Logout</button>
                <button id="theme-toggle" class="text-yellow-400 hover:text-yellow-300 text-xl">🌙</button>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto p-6 space-y-8">
        <!-- Header -->
        <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold">Creative Studio</h1>
        </div>

        <!-- Quote Generation Section -->
        <div class="bg-gray-900 rounded-lg p-6 space-y-4">
            <h2 class="text-xl font-semibold">Generate Quote</h2>
            
            <div class="flex gap-4 items-center">
                <input
                    type="text"
                    id="quote-text"
                    value="Create a motivational quote about success"
                    placeholder="Describe what kind of quote you want..."
                    class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2"
                />
                <select id="quote-tone" class="bg-gray-800 border border-gray-700 rounded px-3 py-2">
                    <option value="default">Default</option>
                    <option value="motivational">Motivational</option>
                    <option value="witty">Witty</option>
                    <option value="poetic">Poetic</option>
                    <option value="bold">Bold</option>
                    <option value="calm">Calm</option>
                </select>
                <button
                    id="generate-quote-btn"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 rounded"
                >
                    Generate Quote
                </button>
            </div>

            <div id="quote-error" class="error text-sm hidden"></div>

            <div id="quote-result" class="bg-gray-800 rounded p-4 space-y-3 hidden">
                <div id="quote-text-display" class="text-lg font-medium"></div>
                <div id="quote-author" class="text-sm text-gray-400 hidden"></div>
                <div id="quote-tone-tag" class="text-xs text-blue-400 hidden"></div>
                
                <!-- Remix buttons (Pro only) -->
                <div id="remix-buttons" class="flex gap-2 hidden">
                    <button id="regenerate-btn" class="px-3 py-1 bg-purple-600 hover:bg-purple-500 disabled:bg-gray-600 rounded text-sm">
                        Regenerate
                    </button>
                    <button id="rephrase-btn" class="px-3 py-1 bg-purple-600 hover:bg-purple-500 disabled:bg-gray-600 rounded text-sm">
                        Rephrase
                    </button>
                    <button id="tone-shift-btn" class="px-3 py-1 bg-purple-600 hover:bg-purple-500 disabled:bg-gray-600 rounded text-sm">
                        Change Tone
                    </button>
                </div>
            </div>
        </div>

        <!-- Asset Selection Section -->
        <div class="bg-gray-900 rounded-lg p-6 space-y-4">
            <h2 class="text-xl font-semibold">Choose Background</h2>
            
            <!-- Asset Type Tabs -->
            <div class="flex gap-2">
                <button id="images-tab" class="px-4 py-2 rounded bg-blue-600" data-type="images">
                    Images
                </button>
                <button id="videos-tab" class="px-4 py-2 rounded bg-gray-700" data-type="videos">
                    Videos
                </button>
                <button id="ai-tab" class="px-4 py-2 rounded bg-gray-700 hidden" data-type="ai">
                    AI Images
                </button>
            </div>

            <!-- Search Controls -->
            <div id="search-controls" class="flex gap-4 items-center">
                <input
                    type="text"
                    id="asset-query"
                    value="nature"
                    placeholder="Search for images/videos..."
                    class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2"
                />
                <button
                    id="search-assets-btn"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 rounded"
                >
                    Search
                </button>
            </div>

            <!-- AI Images Controls -->
            <div id="ai-controls" class="space-y-4 hidden">
                <div class="flex gap-4 items-center">
                    <input
                        type="text"
                        id="ai-prompt"
                        value="A serene mountain landscape at sunset"
                        placeholder="Describe the image you want..."
                        class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2"
                    />
                    <div class="flex flex-col items-center gap-2">
                        <label class="text-sm text-gray-300">Style</label>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400">Realistic</span>
                            <input
                                type="range"
                                id="ai-style-slider"
                                min="0"
                                max="1"
                                step="0.1"
                                value="0.5"
                                class="w-20"
                            />
                            <span class="text-xs text-gray-400">Creative</span>
                        </div>
                    </div>
                    <button
                        id="generate-ai-btn"
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-500 disabled:bg-gray-600 rounded"
                    >
                        Generate
                    </button>
                </div>
                <div id="ai-error" class="error text-sm hidden"></div>
            </div>

            <div id="asset-error" class="error text-sm hidden"></div>

            <!-- Asset Grid -->
            <div id="asset-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Assets will be populated here -->
            </div>

            <!-- Load More Button -->
            <div id="load-more-container" class="text-center hidden">
                <button
                    id="load-more-btn"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 disabled:bg-gray-600 rounded"
                >
                    More Results
                </button>
            </div>

            <!-- Free Plan Notice -->
            <div id="free-notice" class="text-center text-sm text-gray-400 hidden">
                Showing 2 curated assets. 
                <span class="text-blue-400"> Upgrade to Pro</span> for full search and AI images.
            </div>
        </div>

        <!-- Render Section -->
        <div class="bg-gray-900 rounded-lg p-6 space-y-4">
            <h2 class="text-xl font-semibold">Create Short</h2>
            
            <div id="render-preview" class="bg-gray-800 rounded p-4 hidden">
                <div class="text-sm text-gray-400 mb-2">Preview:</div>
                <div id="preview-quote" class="text-lg font-medium mb-2"></div>
                <div id="preview-asset" class="text-sm text-gray-400"></div>
            </div>
            
            <button
                id="render-btn"
                class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded-lg font-medium hidden"
            >
                Render Short
            </button>
        </div>
    </div>

    <script>
        // Global state
        let currentLimits = null;
        let currentQuote = null;
        let selectedAsset = null;
        let currentAssetType = 'images';
        let currentAssetPage = 1;
        let hasMoreAssets = false;
        let currentCredits = 0;

        // Helper functions
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideError(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function setLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            button.disabled = loading;
            button.textContent = loading ? 'Loading...' : button.textContent.replace('Loading...', '');
        }

        // Load credits using existing system
        async function refreshCredits(force = true, retries = 1) {
            if (!window.auth?.currentUser) { 
                updateCreditUI(0); 
                return; 
            }
            try {
                // Use the apiFetch from the imported module
                const { apiFetch } = await import('./api.mjs');
                const data = await apiFetch("/credits", { method: "GET" });
                const credits = Number(data?.credits ?? 0);
                updateCreditUI(Number.isNaN(credits) ? 0 : credits);
            } catch (err) {
                if (retries > 0) return refreshCredits(false, retries - 1);
                console.warn("Credits fetch failed:", err);
            }
        }

        function updateCreditUI(credits) {
            currentCredits = typeof credits === "number" ? credits : 0;
            const creditDisplay = document.getElementById('credit-display');
            const creditCount = document.getElementById('credit-count');
            if (creditDisplay) creditDisplay.classList.remove("hidden");
            if (creditCount) creditCount.textContent = String(currentCredits);
        }

        // Quote generation
        async function generateQuote() {
            if (!window.auth?.currentUser) {
                showError('quote-error', 'Please log in to generate quotes');
                return;
            }
            
            const text = document.getElementById('quote-text').value;
            const tone = document.getElementById('quote-tone').value;
            
            if (!text.trim()) return;
            
            setLoading('generate-quote-btn', true);
            hideError('quote-error');
            
            try {
                const { apiFetch } = await import('./api.mjs');
                const data = await apiFetch('/quotes/generate-quote', {
                    method: 'POST',
                    body: {
                        text,
                        tone: tone === 'default' ? undefined : tone,
                        maxChars: 120
                    }
                });
                
                if (data.ok) {
                    currentQuote = data.data.quote;
                    displayQuote(currentQuote);
                } else {
                    showError('quote-error', data.reason || 'Failed to generate quote');
                }
            } catch (error) {
                showError('quote-error', error.message || 'Network error');
            } finally {
                setLoading('generate-quote-btn', false);
            }
        }

        function displayQuote(quote) {
            document.getElementById('quote-text-display').textContent = quote.text;
            document.getElementById('quote-author').textContent = quote.author ? `— ${quote.author}` : '';
            document.getElementById('quote-author').classList.toggle('hidden', !quote.author);
            document.getElementById('quote-tone-tag').textContent = quote.toneTag ? `Tone: ${quote.toneTag}` : '';
            document.getElementById('quote-tone-tag').classList.toggle('hidden', !quote.toneTag);
            document.getElementById('quote-result').classList.remove('hidden');
            updateRenderPreview();
        }

        // Asset loading
        async function loadAssets(page = 1) {
            if (currentAssetType === 'ai') return;
            if (!window.auth?.currentUser) {
                showError('asset-error', 'Please log in to load assets');
                return;
            }
            
            setLoading('search-assets-btn', true);
            hideError('asset-error');
            
            try {
                const { apiFetch } = await import('./api.mjs');
                const perPage = 16; // Default to 16 for now
                const data = await apiFetch('/assets/options', {
                    method: 'POST',
                    body: {
                        type: currentAssetType,
                        query: document.getElementById('asset-query').value,
                        page,
                        perPage
                    }
                });
                
                if (data.ok) {
                    if (page === 1) {
                        displayAssets(data.data.items);
                    } else {
                        appendAssets(data.data.items);
                    }
                    hasMoreAssets = data.data.nextPage;
                    currentAssetPage = page;
                    updateLoadMoreButton();
                } else {
                    showError('asset-error', data.reason || 'Failed to load assets');
                }
            } catch (error) {
                showError('asset-error', error.message || 'Network error');
            } finally {
                setLoading('search-assets-btn', false);
            }
        }

        function displayAssets(assets) {
            const grid = document.getElementById('asset-grid');
            grid.innerHTML = '';
            assets.forEach(asset => {
                const assetElement = createAssetElement(asset);
                grid.appendChild(assetElement);
            });
        }

        function appendAssets(assets) {
            const grid = document.getElementById('asset-grid');
            assets.forEach(asset => {
                const assetElement = createAssetElement(asset);
                grid.appendChild(assetElement);
            });
        }

        function createAssetElement(asset) {
            const div = document.createElement('div');
            div.className = `border-2 rounded overflow-hidden cursor-pointer transition-colors ${
                selectedAsset?.id === asset.id ? 'border-blue-500' : 'border-gray-700'
            }`;
            div.onclick = () => selectAsset(asset);
            
            let media;
            if (asset.provider === 'ai' || asset.type === 'ai-generated') {
                media = `<img src="${asset.thumbUrl || asset.fileUrl}" alt="${asset.query}" class="w-full h-32 object-cover" />`;
            } else if (currentAssetType === 'images') {
                media = `<img src="${asset.thumbUrl || asset.fileUrl}" alt="${asset.query}" class="w-full h-32 object-cover" />`;
            } else {
                media = `<video src="${asset.fileUrl}" class="w-full h-32 object-cover" muted playsinline></video>`;
            }
            
            const attribution = asset.provider === 'ai' 
                ? '<div class="text-purple-400 truncate">AI Generated</div>'
                : asset.photographer 
                    ? `<div class="text-gray-400 truncate">by ${asset.photographer}</div>`
                    : '';
            
            div.innerHTML = `
                ${media}
                <div class="p-2 text-xs">
                    <div class="truncate">${asset.query}</div>
                    ${attribution}
                </div>
            `;
            
            return div;
        }

        function selectAsset(asset) {
            selectedAsset = asset;
            // Re-render grid to update selection
            loadAssets(1);
            updateRenderPreview();
        }

        function updateLoadMoreButton() {
            const container = document.getElementById('load-more-container');
            const button = document.getElementById('load-more-btn');
            
            if (hasMoreAssets && currentAssetType !== 'ai') {
                container.classList.remove('hidden');
                button.disabled = false;
            } else {
                container.classList.add('hidden');
            }
        }

        function updateRenderPreview() {
            const preview = document.getElementById('render-preview');
            const renderBtn = document.getElementById('render-btn');
            
            if (currentQuote && selectedAsset) {
                document.getElementById('preview-quote').textContent = currentQuote.text;
                document.getElementById('preview-asset').textContent = 
                    `Background: ${selectedAsset.provider === 'ai' ? 'AI Image' : `${currentAssetType} - ${selectedAsset.query}`}`;
                preview.classList.remove('hidden');
                renderBtn.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
                renderBtn.classList.add('hidden');
            }
        }

        // Remix quote function
        async function remixQuote(mode) {
            if (!currentQuote) return;
            if (!window.auth?.currentUser) {
                showError('quote-error', 'Please log in to remix quotes');
                return;
            }
            
            setLoading('generate-quote-btn', true);
            hideError('quote-error');
            
            try {
                const { apiFetch } = await import('./api.mjs');
                const data = await apiFetch('/quotes/remix', {
                    method: 'POST',
                    body: {
                        originalText: currentQuote.text,
                        mode,
                        targetTone: mode === 'tone_shift' ? document.getElementById('quote-tone').value : undefined,
                        maxChars: 120
                    }
                });
                
                if (data.ok) {
                    currentQuote = data.data.quote;
                    displayQuote(currentQuote);
                } else {
                    showError('quote-error', data.reason || 'Failed to remix quote');
                }
            } catch (error) {
                showError('quote-error', error.message || 'Network error');
            } finally {
                setLoading('generate-quote-btn', false);
            }
        }

        // AI Image generation
        async function generateAiImage() {
            if (!window.auth?.currentUser) {
                showError('ai-error', 'Please log in to generate AI images');
                return;
            }
            
            const prompt = document.getElementById('ai-prompt').value;
            const styleSlider = document.getElementById('ai-style-slider').value;
            
            if (!prompt.trim()) {
                showError('ai-error', 'Please enter a prompt');
                return;
            }
            
            setLoading('generate-ai-btn', true);
            hideError('ai-error');
            
            try {
                const { apiFetch } = await import('./api.mjs');
                
                // Map slider value to style: 0-0.5 = realistic, 0.5-1 = cartoon
                const style = parseFloat(styleSlider) <= 0.5 ? 'realistic' : 'cartoon';
                
                const data = await apiFetch('/generate', {
                    method: 'POST',
                    body: {
                        prompt,
                        style,
                        count: 1,
                        options: {}
                    }
                });
                
                if (data.ok || data.images) {
                    // Handle successful generation
                    const images = data.images || data.data?.images || [];
                    if (images.length > 0) {
                        // Create a mock asset object for the generated image
                        const aiAsset = {
                            id: `ai-${Date.now()}`,
                            fileUrl: images[0],
                            thumbUrl: images[0],
                            query: prompt,
                            provider: 'ai',
                            type: 'ai-generated'
                        };
                        
                        // Add to asset grid
                        const grid = document.getElementById('asset-grid');
                        const assetElement = createAssetElement(aiAsset);
                        grid.insertBefore(assetElement, grid.firstChild);
                        
                        // Auto-select the generated image
                        selectAsset(aiAsset);
                    }
                } else {
                    showError('ai-error', data.reason || 'Failed to generate AI image');
                }
            } catch (error) {
                showError('ai-error', error.message || 'Network error');
            } finally {
                setLoading('generate-ai-btn', false);
            }
        }

        // Event listeners
        document.getElementById('generate-quote-btn').onclick = generateQuote;
        document.getElementById('search-assets-btn').onclick = () => loadAssets(1);
        document.getElementById('load-more-btn').onclick = () => loadAssets(currentAssetPage + 1);
        document.getElementById('generate-ai-btn').onclick = generateAiImage;
        document.getElementById('render-btn').onclick = () => {
            alert('Render functionality will be wired to existing render endpoint');
        };

        // Remix button event listeners
        document.getElementById('regenerate-btn').onclick = () => remixQuote('regenerate');
        document.getElementById('rephrase-btn').onclick = () => remixQuote('rephrase');
        document.getElementById('tone-shift-btn').onclick = () => remixQuote('tone_shift');

        // Tab switching
        document.querySelectorAll('[data-type]').forEach(tab => {
            tab.onclick = () => {
                currentAssetType = tab.dataset.type;
                
                // Update tab styles
                document.querySelectorAll('[data-type]').forEach(t => {
                    t.className = 'px-4 py-2 rounded bg-gray-700';
                });
                tab.className = 'px-4 py-2 rounded bg-blue-600';
                
                // Show/hide controls
                const searchControls = document.getElementById('search-controls');
                const aiControls = document.getElementById('ai-controls');
                
                if (currentAssetType === 'ai') {
                    searchControls.classList.add('hidden');
                    aiControls.classList.remove('hidden');
                } else {
                    searchControls.classList.remove('hidden');
                    aiControls.classList.add('hidden');
                }
                
                // Load assets for new type
                if (currentAssetType !== 'ai') {
                    loadAssets(1);
                }
            };
        });

        // Theme toggle functionality
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            if (!themeToggle) return;

            // Set initial theme
            if (localStorage.getItem("theme") === "dark") {
                document.documentElement.classList.add("dark");
                themeToggle.textContent = "🌙";
            } else {
                document.documentElement.classList.remove("dark");
                themeToggle.textContent = "☀️";
            }

            // Theme toggle event listener
            themeToggle.addEventListener("click", () => {
                const isDark = document.documentElement.classList.toggle("dark");
                localStorage.setItem("theme", isDark ? "dark" : "light");
                themeToggle.textContent = isDark ? "🌙" : "☀️";
            });
        }

        // Initialize authentication using existing system
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme first
            initTheme();
            
            // Wait for auth system to be ready
            const checkAuth = () => {
                if (window.auth && window.onAuthStateChanged) {
                    // Listen for auth state changes
                    window.onAuthStateChanged(window.auth, async (user) => {
                        const loggedIn = !!user;
                        
                        // Update UI visibility
                        document.querySelectorAll(".logged-in")?.forEach(el => el.classList.toggle("hidden", !loggedIn));
                        document.querySelectorAll(".logged-out")?.forEach(el => el.classList.toggle("hidden", loggedIn));

                        if (!loggedIn) {
                            updateCreditUI(0);
                            return;
                        }

                        try {
                            // Give api.mjs a brief moment to obtain the token via the bridge
                            if (window.__vaiform_diag__?.tokenWait) { 
                                await window.__vaiform_diag__.tokenWait(4000); 
                            }
                            await refreshCredits(true);
                        } catch (e) {
                            console.error("Failed to refresh credits:", e);
                        }
                    });
                } else {
                    // Retry in 100ms if auth not ready yet
                    setTimeout(checkAuth, 100);
                }
            };
            
            checkAuth();
        });
    </script>
</body>
</html>
