<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Studio - Vaiform</title>
    <!-- Respect saved theme before paint - default to dark -->
    <script>
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "light") {
        document.documentElement.classList.remove("dark");
      } else {
        document.documentElement.classList.add("dark");
      }
    </script>
    <!-- Tailwind CDN must load before config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      };
    </script>
    <!-- Unified Header and Auth -->
    <script type="module">
        import { createUnifiedHeader, initializeHeader } from "/components/header.js";
        import { initializeAuth } from "/components/auth-utils.js";
        
        // Load unified header
        document.getElementById('unified-header').innerHTML = createUnifiedHeader();
        initializeHeader();
        
        // Initialize auth after a short delay to ensure Firebase is ready
        setTimeout(() => {
            initializeAuth();
        }, 100);
    </script>
    
    <!-- Firebase SDK - Load the same way as main site -->
    <script type="module" src="./js/firebaseClient.js"></script>
    <!-- Auth bridge: expose auth & wire token provider before page code -->
    <script type="module" src="./auth-bridge.js"></script>
    <script type="module" src="/js/credits-ui.js?v=20250920b"></script>
    <script type="module">
        // Make credits functions globally available
        import { updateCreditsDisplay, fetchAndUpdateCredits } from '/js/credits-ui.js?v=20250920b';
        window.updateCreditsDisplay = updateCreditsDisplay;
        window.fetchAndUpdateCredits = fetchAndUpdateCredits;
    </script>
    <script type="module">
        // Import render payload helper functions for SSOT preview workflow
        try {
            const { 
                getSavedOverlayMeta, 
                validateOverlayCaption,
                validateBeforeRender,
                showPreviewSavedIndicator,
                markPreviewUnsaved
            } = await import('/js/render-payload-helper.js');
            
            // Make globally available
            window.getSavedOverlayMeta = getSavedOverlayMeta;
            window.validateOverlayCaption = validateOverlayCaption;
            window.validateBeforeRender = validateBeforeRender;
            window.showPreviewSavedIndicator = showPreviewSavedIndicator;
            window.markPreviewUnsaved = markPreviewUnsaved;
            
            console.log('[module] render-payload-helper functions loaded successfully');
        } catch (error) {
            console.error('[module] Failed to load render-payload-helper:', error);
            // Set up fallback functions
            window.showPreviewSavedIndicator = function(containerSelector = '#preview-status') {
                const container = document.querySelector(containerSelector);
                if (!container) return;
                
                const meta = window.getSavedOverlayMeta ? window.getSavedOverlayMeta() : null;
                
                if (meta) {
                    container.innerHTML = `
                        <div class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded text-sm">
                            <span>‚úì</span>
                            <span>Preview saved - ready to render</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="flex items-center gap-2 px-3 py-2 bg-yellow-600 text-white rounded text-sm">
                            <span>‚ö†</span>
                            <span>No preview saved - generate preview before rendering</span>
                        </div>
                    `;
                }
                container.classList.remove('hidden');
            };
            
            window.getSavedOverlayMeta = function() {
                if (window._overlayMeta) return window._overlayMeta;
                try {
                    const stored = localStorage.getItem('overlayMetaV3');
                    if (stored) {
                        const meta = JSON.parse(stored);
                        // Validate ssotVersion === 3
                        if (meta.ssotVersion !== 3) {
                            console.warn('[fallback] Ignoring saved meta with wrong ssotVersion:', meta.ssotVersion);
                            localStorage.removeItem('overlayMetaV3');
                            return null;
                        }
                        window._overlayMeta = meta;
                        return meta;
                    }
                } catch (err) {
                    console.warn('[fallback] Failed to load from localStorage:', err.message);
                }
                return null;
            };
        }
        
        // Initialize preview saved flag
        if (typeof window._previewSavedForCurrentText === 'undefined') {
            window._previewSavedForCurrentText = false;
        }
    </script>
    <!-- Shared geometry utilities for caption positioning -->
    <script src="./js/caption-geom.js"></script>
    <!-- Hybrid caption preview system -->
    <script type="module" src="./js/caption-live.js"></script>
    <!-- Import shared line extraction function -->
    <script type="module">
        import { extractRenderedLines, extractLinesStable } from './js/caption-overlay.js';
        window.extractRenderedLines = extractRenderedLines;
        window.extractLinesStable = extractLinesStable;
    </script>
    <!-- Delegated event system for action buttons -->
    <script src="./js/ui-actions.js"></script>
    <link rel="stylesheet" href="/creative.css" />
    <!-- Font loading handled by creative.css (DejaVu Sans variants via /assets/fonts/) -->
    <!-- Caption rendering now uses server-side PNG overlay - no fonts needed -->
    <style>
        .loading { opacity: 0.6; pointer-events: none; }
        .error { color: #ef4444; }
        .success { color: #10b981; }
        
        /* Force dark mode for content boxes */
        .dark .content-box {
            background-color: #1f2937 !important; /* gray-800 */
            border-color: #4b5563 !important; /* gray-600 */
        }
        
        .dark .content-box h2 {
            color: #ffffff !important;
        }
        
        /* Force dark mode for quote result box */
        .dark #quote-result {
            background-color: #1f2937 !important; /* gray-800 */
            border-color: #4b5563 !important; /* gray-600 */
        }
        
        /* Force dark mode for quote text display */
        .dark #quote-text-display {
            color: #ffffff !important;
        }
        
        /* Force dark mode for quote edit textarea */
        .dark #quote-edit {
            background-color: #111827 !important; /* gray-900 */
            color: #ffffff !important;
            border-color: #4b5563 !important; /* gray-600 */
        }
        
        /* Force dark mode for remix area */
        .dark #remix-area {
            background-color: #1f2937 !important; /* gray-800 */
            border-color: #4b5563 !important; /* gray-600 */
        }
        
        /* Force dark mode for remix area heading */
        .dark #remix-area h3 {
            color: #d1d5db !important; /* gray-300 */
        }
        
        /* Force dark mode for remix assets container */
        .dark #remix-assets {
            background-color: transparent !important;
        }
        
        /* Force dark mode for AI result preview */
        .dark #ai-result-preview {
            background-color: #111827 !important; /* gray-900 */
            border-color: #4b5563 !important; /* gray-600 */
        }
        
        /* Force dark mode for render preview box */
        .dark #render-preview {
            background-color: #1f2937 !important; /* gray-800 */
            border-color: #4b5563 !important; /* gray-600 */
        }
        
        /* Force dark mode for preview text elements */
        .dark #preview-quote {
            color: #ffffff !important;
        }
        
        .dark #preview-asset,
        .dark #preview-caption-style,
        .dark #preview-voiceover {
            color: #9ca3af !important; /* gray-400 */
        }
        
        /* Force dark mode for remix input text */
        .dark #remix-input {
            background-color: #111827 !important; /* gray-900 */
            color: #ffffff !important;
            border-color: #4b5563 !important; /* gray-600 */
        }
        
        /* Force dark mode for clip picker container */
        .dark #clip-picker {
            background-color: #1f2937 !important; /* gray-800 */
            border-color: #4b5563 !important; /* gray-600 */
        }
        
        /* Force dark mode for clip picker heading */
        .dark #clip-picker h3 {
            color: #ffffff !important;
        }
        
        /* Force dark mode for clip picker close button */
        .dark #clip-picker-close {
            color: #9ca3af !important; /* gray-400 */
        }
        
        .dark #clip-picker-close:hover {
            color: #ffffff !important;
        }
        
        /* Force dark mode for clip search input */
        .dark #clip-search-input {
            background-color: #111827 !important; /* gray-900 */
            color: #ffffff !important;
            border-color: #4b5563 !important; /* gray-600 */
        }
        
        /* Force dark mode for clip picker pagination buttons */
        .dark #clip-picker-prev {
            background-color: #374151 !important; /* gray-700 */
            color: #ffffff !important;
        }
        
        .dark #clip-picker-prev:hover:not(:disabled) {
            background-color: #4b5563 !important; /* gray-600 */
        }
        
        /* --- Caption overlay stacking & sizing --- */
        #live-preview-container { position: relative; }
        #live-preview-canvas { position: relative; z-index: 1; display: block; width: 100%; height: auto; }
        #caption-overlay {
            position: absolute;
            left: 0; top: 0;
            width: 100%; height: 100%;
            z-index: 2;
            pointer-events: none;
            opacity: 1;
        }
        /* Make sure preview media and any legacy containers never steal pointer events */
        #stage img, #stage video, #previewMedia, .preview-overlay, #previewOverlayCanvas, #previewOverlayImg {
            pointer-events: none;
            z-index: 1;
        }
        /* Draggable box must sit on top */
        .caption-box, .caption-box .drag-handle { touch-action: none; }
        .caption-box { z-index: 9999; }
        
        /* Add beat button - minimal "+" sign with hover effect */
        .add-beat-btn {
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        .add-beat-btn:hover {
            transform: scale(1.2);
        }
        .beat-text-editing {
            outline: 2px solid #3b82f6;
            outline-offset: -2px;
            background-color: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
        }
        /* Beat video container - 9:16 aspect ratio to match focus modal */
        .beat-video-container {
            aspect-ratio: 9 / 16;
            height: auto !important;
            background-color: #000;
            overflow: hidden;
        }
        
        /* Beat caption preview overlay */
        .beat-caption-overlay {
            position: absolute;
            left: 50%;
            top: calc(var(--y-pct) * 100%);
            width: calc(var(--raster-w-ratio) * 100%);
            height: calc(var(--raster-h-ratio) * 100%);
            transform: translateX(-50%);
            pointer-events: none;
            z-index: 10;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        /* Beat controls overlay - contains delete button */
        .beat-controls {
            position: absolute;
            inset: 0;
            z-index: 50;
            pointer-events: none;
        }
        
        .beat-controls .delete-beat-btn {
            pointer-events: auto;
        }
        
        /* Beat card balloon hover styles */
        .beat-card {
            transition: transform 180ms cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }
        
        .beat-card.beat-hovered {
            transform: scale(1.35);
            transform-origin: top center;
            z-index: 80;
            overflow: visible; /* Allow scaled content to overflow card bounds */
        }
        
        .beat-card.squish-left-1 {
            transform: translateX(-20px);
        }
        
        .beat-card.squish-left-2 {
            transform: translateX(-10px);
        }
        
        .beat-card.squish-right-1 {
            transform: translateX(20px);
        }
        
        .beat-card.squish-right-2 {
            transform: translateX(10px);
        }
        
        /* Storyboard scroll wrapper - handles horizontal scrolling and allows vertical overflow */
        .storyboard-scroll-wrapper {
            overflow-x: auto;
            overflow-y: visible;
            padding-top: 24px;
            padding-bottom: 140px;
            width: 100%;
        }
        
        /* Storyboard row - no overflow constraints, allows content to overflow vertically */
        #storyboard-row {
            overflow: visible;
        }
        
        /* Extra padding when actively hovering a card */
        #storyboard.storyboard-hovering .storyboard-scroll-wrapper {
            padding-bottom: 160px;
        }
        
        /* Beat Focus Preview Modal */
        #beat-focus-modal {
            position: fixed;
            inset: 0;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
        }
        
        #beat-focus-modal.show {
            display: flex;
        }
        
        #beat-focus-panel {
            position: relative;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            background-color: #1f2937;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }
        
        #beat-focus-video-container {
            position: relative;
            height: min(70vh, 720px);
            aspect-ratio: 9 / 16;
            width: auto;
            max-width: 80vw;
            margin: 0 auto;
            background-color: #000;
            overflow: hidden;
        }
        
        #beat-focus-video {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        
        #beat-focus-overlay {
            position: absolute;
            left: 50%;
            top: calc(var(--y-pct) * 100%);
            width: calc(var(--raster-w-ratio) * 100%);
            height: calc(var(--raster-h-ratio) * 100%);
            transform: translateX(-50%);
            pointer-events: none;
            z-index: 10;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        #beat-focus-text {
            padding: 1.5rem;
            color: #e5e7eb;
            font-size: 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        #beat-focus-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.7);
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: background-color 0.2s;
        }
        
        #beat-focus-close:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }
        
        #beat-focus-preview-note {
            padding: 1rem;
            text-align: center;
            color: #9ca3af;
            font-size: 0.875rem;
            background-color: #374151;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 min-h-screen transition-colors duration-300">
    <!-- Unified Header -->
    <div id="unified-header"></div>

    <!-- Hero Section -->
    <section class="w-full md:max-w-5xl md:mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12 bg-gray-50 dark:bg-gray-900">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between md:gap-8">
            <div class="flex-1">
                <p class="text-sm text-gray-500 dark:text-gray-100 mb-3">Articles ‚Üí Shorts</p>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">From articles and ideas to finished videos.</h1>
                <p class="text-base text-gray-600 dark:text-gray-100 leading-relaxed">No timeline, no editing software.<br>Just your link, notes, or idea‚Äîand a video that's ready to post.</p>
            </div>
            <div class="mt-6 md:mt-0 md:flex-shrink-0">
                <div class="space-y-3 text-sm text-gray-600 dark:text-gray-100">
                    <div class="flex items-start gap-2">
                        <span class="text-lg">‚ë†</span>
                        <span>Start with an article, notes, or idea</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-lg">‚ë°</span>
                        <span>Shape the script and beats</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-lg">‚ë¢</span>
                        <span>Render video</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <main class="w-full md:max-w-5xl md:mx-auto px-4 sm:px-6 lg:px-8 pb-16 space-y-6 bg-gray-50 dark:bg-gray-900">
        <!-- Mode Toggle Tabs -->
        <div class="flex gap-2 mb-2 md:mb-4">
            <button
                id="mode-quotes-tab"
                data-action="setModeQuotes"
                type="button"
                class="px-4 py-2 rounded bg-blue-600 text-white font-medium"
            >
                Quotes
            </button>
        </div>

        <!-- Accordion Layout -->
        <!-- Mobile order: quote ‚Üí CTA ‚Üí preview. Desktop: preview ‚Üí quote ‚Üí CTA -->
        <div class="studio-accordion-layout flex flex-col md:grid md:grid-cols-2">
            <!-- Left: Accordion Sections -->
            <div class="studio-accordion-left order-1 md:order-2">
                <!-- Quote Section -->
                <div class="accordion-section" data-mode="quotes">
                    <div class="accordion-header active" data-section="quote">
                        <div class="accordion-title">
                            <span class="accordion-icon">‚ñº</span>
                            <span class="accordion-label">Step 1 ‚Äì Your Quote</span>
                        </div>
                        <div class="accordion-summary" id="quote-summary">Write your own quote or let AI suggest one.</div>
                    </div>
                    <div class="accordion-body active" id="quote-body">

                        <!-- Quote Generation Section -->
                        <div id="section-quote" class="content-box bg-gray-50/80 dark:bg-slate-900/60 border border-gray-200/50 dark:border-white/5 rounded-2xl p-4 md:p-6 space-y-4 shadow-sm w-full">
                            <div class="text-xs text-gray-400 dark:text-gray-500 mb-2">Step 1 ¬∑ Your quote</div>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Generate Quote</h2>
                            <p class="text-sm text-gray-600 dark:text-gray-400 leading-tight">Describe the kind of quote you want, or type your own.</p>
            
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:gap-4">
                <input
                    type="text"
                    id="quote-text"
                    value="Create a motivational quote about success"
                    placeholder="Describe the quote you want‚Ä¶"
                    class="w-full md:flex-1 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white"
                />
                <div class="hidden md:block text-xs text-gray-500 dark:text-gray-400 w-20 text-right" id="quote-char-count">0/200</div>
                <div class="flex flex-col sm:flex-row gap-2 md:gap-4">
                    <select id="quote-tone" class="flex-1 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white">
                        <option value="default">Default</option>
                        <option value="motivational">Motivational</option>
                        <option value="witty">Witty</option>
                        <option value="poetic">Poetic</option>
                        <option value="bold">Bold</option>
                        <option value="calm">Calm</option>
                    </select>
                    <button
                        id="generate-quote-btn"
                        data-action="generateQuote"
                        type="button"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 rounded whitespace-nowrap"
                    >
                        Generate Quote
                    </button>
                </div>
            </div>

            <div id="quote-error" class="error text-sm hidden"></div>

            <div id="quote-result" class="bg-gray-100 dark:bg-gray-800 rounded p-3 md:p-4 space-y-3 border border-gray-200 dark:border-gray-700">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex-1">
                        <div id="quote-text-display" class="text-lg font-medium text-gray-900 dark:text-white hidden"></div>
                        <textarea id="quote-edit" class="w-full bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-sm text-gray-900 dark:text-white" rows="4" placeholder="Enter your quote here or generate one above..."></textarea>
                        <!-- Primary actions row -->
                        <div class="flex gap-2 mt-2">
                            <button id="save-quote-btn" data-action="saveQuote" type="button" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-base font-medium text-white">Save</button>
                            <button id="cancel-quote-btn" data-action="cancelEdit" type="button" class="px-4 py-2 bg-gray-600 dark:bg-gray-700 hover:bg-gray-700 dark:hover:bg-gray-600 rounded text-base font-medium text-white hidden">Cancel</button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 items-end">
                        <div id="regen-info" class="hidden md:block text-xs text-gray-400">Regens left: 10</div>
                        <div class="flex gap-2">
                            <button id="edit-quote-btn" data-action="editQuote" type="button" class="px-3 py-1 bg-gray-600 dark:bg-neutral-700 hover:bg-gray-700 dark:hover:bg-neutral-600 rounded text-sm text-white hidden">Edit</button>
                        </div>
                    </div>
                </div>
                <div id="quote-author" class="text-sm text-gray-400 hidden"></div>
                <div id="quote-tone-tag" class="text-xs text-blue-400 hidden"></div>
                
                <!-- Secondary actions row (less emphasis) -->
                <div id="remix-buttons" class="flex gap-2 mt-2">
                    <button id="regenerate-btn" data-action="regenerateQuote" type="button" class="px-3 py-1.5 border border-purple-600 dark:border-purple-500 text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm">
                        Regenerate
                    </button>
                    <button id="rephrase-btn" data-action="rephraseQuote" type="button" class="px-3 py-1.5 border border-purple-600 dark:border-purple-500 text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm">
                        Rephrase
                    </button>
                    <button id="tone-shift-btn" data-action="changeTone" type="button" class="px-3 py-1.5 border border-purple-600 dark:border-purple-500 text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm">
                        Change Tone
                    </button>
                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Media Section -->
                <div class="accordion-section" data-mode="quotes">
                    <div class="accordion-header" data-section="media">
                        <div class="accordion-title">
                            <span class="accordion-icon">‚ñ∂</span>
                            <span class="accordion-label">Step 2 ‚Äì Background</span>
                        </div>
                        <div class="accordion-summary" id="media-summary">No background selected</div>
                    </div>
                    <div class="accordion-body" id="media-body">
                        <!-- Asset Selection Section -->
                        <div id="section-media" class="content-box bg-gray-50/80 dark:bg-slate-900/60 border border-gray-200/50 dark:border-white/5 rounded-2xl p-4 md:p-6 space-y-4 shadow-sm">
                            <div class="text-xs text-gray-400 dark:text-gray-500 mb-2">Step 2 ¬∑ Background</div>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Background</h2>
            
            <!-- Asset Type Tabs -->
            <div class="flex gap-2">
                <button id="images-tab" data-action="setMediaTab" type="button" class="px-4 py-2 rounded bg-blue-600 text-white" data-type="images">
                    Images
                </button>
                <button id="videos-tab" data-action="setMediaTab" type="button" class="px-4 py-2 rounded bg-gray-600 dark:bg-gray-700 text-white" data-type="videos">
                    Videos
                </button>
                <button id="ai-tab" class="px-4 py-2 rounded bg-gray-600 dark:bg-gray-700 text-white hidden" data-type="ai">
                    AI Images
                </button>
            </div>

            <!-- Remix Area -->
            <div id="remix-area" class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4 hidden border border-gray-200 dark:border-gray-700">
                <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Remix References (up to 2)</h3>
                <div id="remix-assets" class="flex gap-4">
                    <!-- Remix assets will be added here -->
                </div>
                <!-- AI result preview slot -->
                <div id="ai-result-block" class="mt-3 hidden">
                    <div class="flex flex-col items-center gap-2">
                        <div id="ai-ref-preview" class="flex gap-2 justify-center"></div>
                        <div id="ai-result-preview" class="relative w-full rounded overflow-hidden border border-gray-600 bg-black" style="aspect-ratio: 9/16;"></div>
                        <div class="mt-2">
                            <button id="ai-save-use-btn" class="px-3 py-1 bg-green-600 hover:bg-green-500 text-white text-xs rounded">Save & Use</button>
                        </div>
                    </div>
                </div>
                <!-- Inline AI prompt + style for ideogram remix -->
                <div class="mt-3 flex flex-wrap items-center gap-3">
                    <input
                        type="text"
                        id="ai-prompt"
                        value="A serene mountain landscape at sunset"
                        placeholder="Describe what to create from these references..."
                        class="flex-1 min-w-[16rem] bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-sm text-gray-900 dark:text-white"
                    />
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-400">Realistic</span>
                        <input type="range" id="ai-style-slider" min="0" max="1" step="0.1" value="0.5" class="w-24" />
                        <span class="text-xs text-gray-400">Creative</span>
                    </div>
                </div>
                <div class="mt-3 flex items-center gap-2">
                    <button
                        id="clear-remix-btn"
                        class="px-3 py-1 bg-red-600 hover:bg-red-500 text-white text-xs rounded"
                    >
                        Clear All
                    </button>
                    <button
                        id="remix-generate-btn"
                        class="px-3 py-1 bg-purple-600 hover:bg-purple-500 text-white text-xs rounded"
                        title="Generate a new AI image using the selected references"
                    >
                        20 Credits
                    </button>
                </div>
            </div>

            <!-- Search Controls -->
            <div id="search-controls" class="flex gap-4 items-center">
                <input
                    type="text"
                    id="asset-query"
                    value="nature"
                    placeholder="Search for images/videos..."
                    class="flex-1 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white"
                />
                <button
                    id="search-assets-btn"
                    data-action="searchAssets"
                    type="button"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 rounded text-white"
                >
                    Search
                </button>
                <button
                    id="upload-asset-btn"
                    class="px-3 py-2 bg-gray-600 dark:bg-gray-700 hover:bg-gray-700 dark:hover:bg-gray-600 rounded text-white"
                    title="Upload your own image or video"
                >
                    üìÅ
                </button>
                <input
                    type="file"
                    id="asset-upload-input"
                    accept="image/*,video/*"
                    class="hidden"
                />
            </div>

            <!-- AI Images Controls removed (inline controls are now in remix-area) -->
            <div id="ai-error" class="error text-sm hidden"></div>

            <div id="asset-error" class="error text-sm hidden"></div>

            <!-- Asset Grid (3 rows √ó 4 columns ‚âà 12 results) -->
            <div id="asset-grid" class="grid grid-cols-4 gap-4">
                <!-- Assets will be populated here -->
            </div>

            <!-- Pagination Controls -->
            <div id="pagination-container" class="flex justify-between items-center mt-4 hidden">
                <button
                    id="prev-page-btn"
                    class="px-4 py-2 bg-gray-600 dark:bg-gray-700 hover:bg-gray-700 dark:hover:bg-gray-600 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:opacity-50 rounded flex items-center gap-2 text-white"
                >
                    ‚Üê Previous
                </button>
                <span id="page-info" class="text-sm text-gray-600 dark:text-gray-400">Page 1</span>
                <button
                    id="next-page-btn"
                    class="px-4 py-2 bg-gray-600 dark:bg-gray-700 hover:bg-gray-700 dark:hover:bg-gray-600 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:opacity-50 rounded flex items-center gap-2 text-white"
                >
                    Next ‚Üí
                </button>
            </div>

            <!-- Free Plan Notice -->
            <div id="free-notice" class="text-center text-sm text-gray-400 hidden">
                Showing 12 curated assets. 
                <span class="text-blue-400"> Upgrade to Pro</span> for larger pages and AI images.
            </div>
        </div>

        <!-- Caption Style Section (Hidden during transition) -->
        <div id="caption-style-section" class="content-box bg-white dark:bg-gray-800 rounded-lg p-6 space-y-4 border border-gray-200 dark:border-gray-600" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Caption Style</h2>
            
            <!-- Overlay Mode Toggle -->
            <div class="mb-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="overlay-mode-toggle" class="rounded" />
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Use Draggable Overlay</span>
                </label>
            </div>
            
            <!-- Overlay Controls (shown when overlay mode is enabled) -->
            <div id="overlay-controls" class="mb-4 space-y-3" style="display: none;">
                <div>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="show-outline-toggle" class="rounded" checked />
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Show outline</span>
                    </label>
                </div>
                <div>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="responsive-text-toggle" class="rounded" checked />
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Responsive text</span>
                    </label>
                </div>
            </div>
            
            
            
            <div class="grid grid-cols-2 gap-4">
                <!-- Font Family -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Font</label>
                    <select id="caption-font" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white">
                        <option value="system">System</option>
                        <option value="bold">Bold</option>
                        <option value="cinematic">Cinematic</option>
                        <option value="minimal">Minimal</option>
                    </select>
                </div>
                
                <!-- Font Weight -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Weight</label>
                    <select id="caption-weight" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white">
                        <option value="normal">Normal</option>
                        <option value="bold">Bold</option>
                    </select>
                </div>
                
                <!-- Size -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Size: <span id="size-value">80px</span></label>
                    <input
                        type="range"
                        id="caption-size"
                        min="0"
                        max="100"
                        value="60"
                        class="w-full"
                    />
                </div>
                
                <!-- Opacity -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Opacity: <span id="opacity-value">80%</span></label>
                    <input
                        type="range"
                        id="caption-opacity"
                        min="30"
                        max="100"
                        value="80"
                        class="w-full"
                    />
                </div>
                
                <!-- Placement -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Placement</label>
                    <select id="caption-placement" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white">
                        <option value="top">Top</option>
                        <option value="middle">Middle</option>
                        <option value="bottom" selected>Bottom</option>
                    </select>
                </div>
                
                <!-- Background Box -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Background</label>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="caption-background" class="rounded" />
                            <span class="text-sm">Show box</span>
                        </label>
                        <div class="flex-1">
                            <label class="block text-xs text-gray-400 mb-1">Box opacity: <span id="bg-opacity-value">50%</span></label>
                            <input
                                type="range"
                                id="caption-bg-opacity"
                                min="0"
                                max="100"
                                value="50"
                                class="w-full"
                            />
                        </div>
                    </div>
                </div>
                
                <!-- Apply Caption Settings Button -->
                <div class="mt-4">
                    <button id="apply-caption-style-btn" type="button" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-base font-medium text-white">
                        Apply Caption Settings
                    </button>
                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Voiceover Section -->
                <div class="accordion-section md:hidden">
                    <div class="accordion-header" data-section="voice">
                        <div class="accordion-title">
                            <span class="accordion-icon">‚ñ∂</span>
                            <span class="accordion-label">Step 3 ‚Äì Voiceover (optional)</span>
                        </div>
                        <div class="accordion-summary" id="voice-summary">No voice selected</div>
                    </div>
                    <div class="accordion-body" id="voice-body">
                        <!-- Voiceover Section -->
                        <div id="section-voice" class="content-box bg-gray-50/80 dark:bg-slate-900/60 border border-gray-200/50 dark:border-white/5 rounded-2xl p-4 md:p-6 space-y-4 shadow-sm">
                            <div class="text-xs text-gray-400 dark:text-gray-500 mb-2">Step 3 ¬∑ Voiceover</div>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Voiceover</h2>
                            <p class="text-sm text-gray-600 dark:text-gray-400 leading-tight">Add AI voice if you want audio, or leave this empty for a silent image or video.</p>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Voice</label>
                    <div class="flex gap-2">
                        <select id="voiceover-voice" class="flex-1 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white">
                            <option value="">Loading voices...</option>
                        </select>
                        <button id="retry-voices-btn" onclick="loadVoices()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
                            üîÑ
                        </button>
                    </div>
                </div>
                <div class="flex items-end gap-2">
                    <button
                        id="preview-voice-btn"
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded disabled:bg-gray-400 dark:disabled:bg-gray-600 text-white"
                        disabled
                    >
                        Preview Voice
                    </button>
                    <audio id="voice-preview-audio" class="hidden" controls></audio>
                </div>
            </div>
            
            <!-- TTS Settings -->
            <div class="grid grid-cols-2 gap-4 mt-4" data-mode="quotes">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stability</label>
                    <input type="range" id="tts-stability" min="0" max="1" step="0.1" value="0.5" class="w-full">
                    <div class="text-xs text-gray-500 mt-1">Value: <span id="stability-value">0.5</span></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Similarity Boost</label>
                    <input type="range" id="tts-similarity" min="0" max="1" step="0.1" value="0.75" class="w-full">
                    <div class="text-xs text-gray-500 mt-1">Value: <span id="similarity-value">0.75</span></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Style</label>
                    <input type="range" id="tts-style" min="0" max="100" step="1" value="0" class="w-full">
                    <div class="text-xs text-gray-500 mt-1">Value: <span id="style-value">0</span></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Speaker Boost</label>
                    <input type="checkbox" id="tts-speaker-boost" checked class="rounded">
                    <div class="text-xs text-gray-500 mt-1">Enhance speaker characteristics</div>
                </div>
            </div>
            
                            <div id="voice-preview-status" class="text-sm text-gray-400 hidden"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Article Mode Section (full width on desktop) -->
            <div data-mode="articles" class="content-box bg-gray-50/80 dark:bg-slate-900/60 border border-gray-200/50 dark:border-white/5 rounded-2xl p-4 md:p-6 space-y-2 shadow-sm w-full md:col-span-2" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Article Explainer</h2>
                
                <!-- Input Section -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Style</label>
                    <select
                        id="article-style-select"
                        class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white"
                    >
                        <option value="default">Default (Explainer)</option>
                        <option value="hype">Hype</option>
                        <option value="cozy">Cozy</option>
                    </select>
                    <textarea
                        id="article-input"
                        rows="4"
                        placeholder="Paste article URL or text here..."
                        class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white"
                    ></textarea>
                    <button
                        id="summarize-article-btn"
                        data-action="summarizeArticle"
                        type="button"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 rounded text-white"
                    >
                        Summarize into script
                    </button>
                    <div id="article-error" class="error text-sm hidden"></div>
                </div>

                <!-- Script Preview Section -->
                <div id="article-script-section" class="space-y-2 mt-2">
                    <div class="flex justify-between items-center">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Script Preview</label>
                        <button
                            id="toggle-view-btn"
                            type="button"
                            class="text-xs px-2 py-1 bg-gray-600 hover:bg-gray-500 rounded text-white"
                        >
                            Beat View
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 leading-tight">Each numbered beat becomes one clip (beats can wrap to multiple lines).</p>
                    <textarea
                        id="article-script-preview"
                        rows="4"
                        placeholder="Script will appear here after summarization..."
                        class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white"
                    ></textarea>
                    <!-- Beat Editor (initially hidden) -->
                    <div id="beat-editor" class="space-y-2 hidden">
                        <div id="beat-list" class="space-y-2"></div>
                        <div class="flex justify-between items-center">
                            <button
                                id="add-beat-btn"
                                type="button"
                                class="text-xs px-2 py-1 bg-gray-600 hover:bg-gray-500 disabled:bg-gray-400 disabled:cursor-not-allowed rounded text-white"
                            >
                                + Add beat
                            </button>
                            <div id="beat-editor-counters" class="text-xs text-gray-500 dark:text-gray-400"></div>
                        </div>
                    </div>
                    <!-- Counters: show only in raw view -->
                    <div id="script-preview-counters" class="text-xs text-gray-500 dark:text-gray-400">
                        Beats: 0 / 8 | Total: 0 / 850
                    </div>
                </div>

                <!-- Prepare Storyboard Button -->
                <div class="mt-2 mb-1">
                    <button
                        id="prepare-storyboard-btn"
                        data-action="prepareStoryboard"
                        type="button"
                        class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 disabled:cursor-not-allowed rounded text-white"
                    >
                        Prepare storyboard
                    </button>
                </div>

                <!-- Storyboard Section -->
                <div id="storyboard" class="mt-2 hidden">
                    <div class="text-xs text-gray-400 dark:text-gray-500 mb-2">Step 2 ¬∑ Storyboard</div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">Storyboard</h3>
                    <div id="storyboard-scroll" class="storyboard-scroll-wrapper w-full">
                        <div id="storyboard-row" class="flex gap-3 pb-2"></div>
                    </div>
                    <!-- Caption Style mount point -->
                    <div id="caption-style-mount"></div>
                    <!-- Video Cuts (beta) - visible when window.ENABLE_VIDEO_CUTS_UI && session && N >= 2 -->
                    <div id="video-cuts-panel" class="mt-4 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded text-sm hidden">
                        <div class="font-semibold text-gray-900 dark:text-white mb-2">Video Cuts (beta)</div>
                        <div id="video-cuts-warning" class="text-amber-600 dark:text-amber-400 text-xs mb-2 hidden"></div>
                        <div class="space-y-2">
                            <label class="block text-gray-700 dark:text-gray-300">Boundary <select id="video-cuts-boundary-index" class="ml-1 bg-gray-200 dark:bg-gray-700 border border-gray-400 dark:border-gray-500 rounded px-2 py-1"></select></label>
                            <label class="block text-gray-700 dark:text-gray-300">beatIndex <input type="number" id="video-cuts-beat-index" min="1" max="1" class="w-16 ml-1 bg-gray-200 dark:bg-gray-700 border border-gray-400 dark:border-gray-500 rounded px-2 py-1" /></label>
                            <label class="block text-gray-700 dark:text-gray-300">pct <input type="range" id="video-cuts-pct" min="0" max="1" step="0.01" value="0.35" class="align-middle" /><span id="video-cuts-pct-value" class="ml-1">0.35</span></label>
                            <div class="flex gap-2 mt-2">
                                <button type="button" id="video-cuts-save-btn" class="px-3 py-1.5 rounded bg-blue-600 hover:bg-blue-500 text-white text-xs">Save Cuts</button>
                                <button type="button" id="video-cuts-reset-btn" class="px-3 py-1.5 rounded bg-gray-600 hover:bg-gray-500 text-white text-xs">Reset Cuts</button>
                            </div>
                        </div>
                        <pre id="video-cuts-debug" class="mt-2 p-2 bg-gray-200 dark:bg-gray-900 rounded text-xs overflow-auto max-h-24 text-gray-800 dark:text-gray-200"></pre>
                    </div>
                </div>
                
                <!-- Beat Focus Preview Modal -->
                <div id="beat-focus-modal">
                    <div id="beat-focus-panel">
                        <button id="beat-focus-close" aria-label="Close preview">‚úï</button>
                        <div id="beat-focus-video-container">
                            <video id="beat-focus-video" muted loop preload="auto"></video>
                            <img id="beat-focus-overlay" alt="Caption overlay" style="display: none;" />
                        </div>
                        <div id="beat-focus-preview-note" style="display: none;">
                            Preview not ready yet
                        </div>
                        <div id="beat-focus-text"></div>
                    </div>
                </div>

                <!-- Clip Picker Drawer -->
                <div id="clip-picker" class="mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-4 hidden max-h-[75vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-semibold text-gray-900 dark:text-white">Choose a clip for this line</h3>
                        <button id="clip-picker-close" class="text-xs text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white px-2 py-1">Close</button>
                    </div>
                    <div class="flex items-center gap-2 mb-3">
                        <input
                            id="clip-search-input"
                            type="text"
                            class="flex-1 px-2 py-1 rounded bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 text-sm text-gray-900 dark:text-white placeholder-gray-400"
                            placeholder="Search clips for this sentence..."
                        />
                        <button
                            id="clip-search-btn"
                            class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-500 text-sm font-medium text-white"
                        >
                            Search
                        </button>
                    </div>
                    <div id="clip-picker-grid" class="grid grid-cols-2 md:grid-cols-4 gap-2 max-h-96 overflow-y-auto"></div>
                    <div id="clip-picker-pagination" class="flex justify-center items-center gap-2 mt-3 hidden">
                        <button
                            id="clip-picker-prev"
                            class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm font-medium text-gray-900 dark:text-white disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Previous
                        </button>
                        <button
                            id="clip-picker-more"
                            class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-500 text-sm font-medium text-white disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            More clips
                        </button>
                    </div>
                </div>

                <!-- Voice Selection -->
                <div class="space-y-2 mt-2">
                    <div class="text-xs text-gray-400 dark:text-gray-500 mb-2">Step 3 ¬∑ Voice & render</div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Voice</label>
                    <select
                        id="article-voice-preset"
                        class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-2 text-gray-900 dark:text-white"
                    >
                        <option value="male_calm">Neutral</option>
                        <option value="male_friendly">Warm</option>
                        <option value="male_energetic">Energetic</option>
                    </select>
                </div>

                <!-- Render Button -->
                <div class="mt-2">
                    <button
                        id="render-article-btn"
                        data-action="renderArticle"
                        type="button"
                        class="w-full px-6 py-3 bg-green-600 hover:bg-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg text-base font-semibold text-white shadow-md transition-colors"
                    >
                        Render video
                    </button>
                </div>

                <!-- Last Render Video Player -->
                <div id="article-render-result" class="mt-2 hidden">
                    <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Last render</h3>
                    <video
                        id="article-render-video"
                        controls
                        class="w-full rounded border border-gray-300 dark:border-gray-700"
                    ></video>
                    <div id="article-render-links" class="mt-2 space-y-1">
                        <a id="article-video-url" href="#" target="_blank" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">Open video</a>
                    </div>
                </div>
            </div>

            <!-- Right: Preview Section -->
            <div class="studio-accordion-right order-3 md:order-1">
                <!-- Render Section -->
                <div class="content-box bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 space-y-4 border border-gray-200 dark:border-gray-600 w-full" data-mode="quotes">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Live Preview</h2>
            
            <!-- Caption Toolbar Container (docked) -->
            <div id="caption-toolbar-container" class="my-3 flex justify-center items-center flex-wrap gap-2 hidden">
                <!-- Toolbar will be inserted here by JS -->
            </div>
            
            <!-- Live Preview Canvas -->
            <div id="live-preview-container" class="opacity-0 transition-opacity duration-300" style="min-height: 400px; width: 360px;">
                <!-- Fix A: Give the preview wrapper a predictable size -->
                <div class="relative mx-auto bg-black rounded-lg overflow-hidden" style="width: 360px; aspect-ratio: 9 / 16;">
                    <canvas id="live-preview-canvas" class="w-full h-full block"></canvas>
                    <!-- One-Click status overlay -->
                    <div
                      id="one-click-status"
                      class="pointer-events-none absolute inset-0 z-40 flex items-center justify-center text-center px-4 text-sm sm:text-base font-semibold text-white bg-black/60 opacity-0 transition-opacity duration-200"
                      aria-hidden="true"
                    >
                      <span id="one-click-status-text"></span>
                    </div>
                    <!-- Legacy caption overlay (hidden when using new overlay system) -->
                    <img
                      id="caption-overlay"
                      class="absolute inset-0 pointer-events-none block w-full h-full"
                      style="z-index:2"
                    />
                    <!-- Hybrid preview layers for live text + PNG swap -->
                    <div id="caption-live" contenteditable="true" style="position:absolute; inset:0; pointer-events:auto; z-index:20; display:none; font-family: 'DejaVu Sans', sans-serif; color: white; text-align: center; padding: 24px; box-sizing: border-box;"></div>
                    <img id="preview-raster-img" alt="caption png" style="position:absolute; inset:0; pointer-events:none; z-index:10; display:none; object-fit: contain;" />
                    <!-- New draggable caption overlay container -->
                    <div id="stage" class="absolute inset-0 w-full h-full" style="z-index:3; display:none;">
                        <img id="previewMedia" class="w-full h-full object-cover" />
                    </div>
                    </div>
                </div>
                
                <!-- Mobile Toolbar (visible only on mobile) -->
                <div id="mobile-studio-toolbar" class="hidden w-full" data-mode="quotes">
                    <div class="flex items-center gap-2 w-full" style="max-width: 100%;">
                        <!-- Step Tabs -->
                        <button
                            id="mobile-tab-quote"
                            class="mobile-studio-tab flex-1 px-3 py-2 text-sm font-medium rounded-lg border transition-colors"
                            data-section="quote"
                        >
                            Quote
                        </button>
                        <button
                            id="mobile-tab-background"
                            class="mobile-studio-tab flex-1 px-3 py-2 text-sm font-medium rounded-lg border transition-colors"
                            data-section="media"
                        >
                            Background
                        </button>
                        <button
                            id="mobile-tab-voiceover"
                            class="mobile-studio-tab flex-1 px-3 py-2 text-sm font-medium rounded-lg border transition-colors"
                            data-section="voice"
                        >
                            Voiceover
                        </button>
                        <!-- Create Button -->
                        <button
                            id="mobile-create-btn"
                            class="px-4 py-2 bg-green-600 hover:bg-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg text-sm font-semibold text-white shadow-md transition-colors whitespace-nowrap"
                            title="Create your short"
                        >
                            Create
                        </button>
                        <!-- One-Click Short Button (Mobile) -->
                        <button
                            id="mobile-one-click-btn"
                            data-action="oneClickShort"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg text-sm font-semibold text-white shadow-md transition-colors whitespace-nowrap"
                            title="One-click: Generate quote, find background, and render automatically"
                        >
                            One-Click
                        </button>
                    </div>
                </div>
                
                <!-- Helper text for empty preview -->
                <div id="preview-helper-text" class="mt-3 text-center text-sm text-gray-500 dark:text-gray-400 hidden">
                    Start by writing a quote, then choose an image or video background.
                </div>
                
                <!-- Render buttons below preview -->
                <div class="mt-4 flex flex-col items-center gap-3">
                    <!-- Preview Status Indicator -->
                    <div id="preview-status" class="hidden"></div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3" data-mode="quotes">
                        <!-- Create Button (combines Save Preview + Render) -->
                        <button
                            id="render-btn"
                            class="px-6 py-3 bg-green-600 hover:bg-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg text-base font-semibold text-white shadow-md transition-colors"
                            title="Create your short"
                        >
                            Create
                        </button>
                    </div>
                </div>
                
                <div id="render-preview" class="bg-gray-100 dark:bg-gray-800 rounded p-4 hidden border border-gray-200 dark:border-gray-700">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">Preview:</div>
                    <div id="preview-quote" class="text-lg font-medium mb-2 text-gray-900 dark:text-white"></div>
                    <div id="preview-asset" class="text-sm text-gray-600 dark:text-gray-400"></div>
                    <div id="preview-caption-style" class="text-sm text-gray-600 dark:text-gray-400"></div>
                    <div id="preview-voiceover" class="text-sm text-gray-600 dark:text-gray-400"></div>
                </div>
            </div>
            
            <!-- One-Click Short Button (reordered for mobile) -->
            <div class="order-2 md:order-3 md:col-start-2 flex justify-center md:justify-start md:hidden" data-mode="quotes">
                <button
                    id="one-click-btn"
                    data-action="oneClickShort"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg text-base font-semibold text-white shadow-md transition-colors w-full md:w-auto"
                    title="One-click: Generate quote, find background, and render automatically"
                >
                    One-Click Short
                </button>
            </div>
        </div>
    </div>

    <script type="module" src="/js/pages/creative/creative.main.mjs"></script>

    <script>
      // ========================================
      // AUDIT NOTES (Phase 0 findings):
      // - Router: Single delegated click router in ui-actions.js using [data-action]
      // - Router style: Calls window.* functions (generateQuote, remixQuote, loadAssets, etc.)
      // - DOM selectors: Already correct (#quote-text, #quote-tone, #quote-result, #asset-query, #asset-grid)
      // - Functions exposed: window.generateQuote (line ~1706), window.loadAssets (~1801), window.remixQuote (~3236)
      // - Now also exposed: window.editQuote, window.cancelEdit, window.saveQuote (~3754-3756)
      // - No legacy-gate blocks found
      // - SSOT: One router (ui-actions.js), one set of controllers, one overlay update path
      // - Safe `must()` helper already exists at line ~1046
      // ========================================

      // Accordion behavior - single open section
      (function(){
        const headers = document.querySelectorAll('.accordion-header');
        const bodies = document.querySelectorAll('.accordion-body');
        
        // Check if we're on mobile
        function isMobile() {
          return window.matchMedia('(max-width: 768px)').matches;
        }
        
        function toggleSection(targetSection) {
          const targetHeader = document.querySelector(`[data-section="${targetSection}"]`);
          const targetBody = document.getElementById(`${targetSection}-body`);
          const targetIcon = targetHeader?.querySelector('.accordion-icon');
          
          // Toggle the clicked section
          if (targetHeader?.classList.contains('active')) {
            // Close if already open
            targetHeader.classList.remove('active');
            targetBody?.classList.remove('active');
            targetIcon.textContent = '‚ñ∂';
          } else {
            // Open if closed
            targetHeader.classList.add('active');
            targetBody?.classList.add('active');
            targetIcon.textContent = '‚ñº';
          }
        }
        
        headers.forEach(header => {
          header.addEventListener('click', (event) => {
            // On mobile, accordion headers are handled by mobile tab logic
            if (isMobile()) {
              return; // Let mobile tab logic handle it
            }
            
            // Desktop behavior: only toggle if clicking the header itself, not buttons inside
            if (event.target === header || event.target.closest('.accordion-header') === header) {
              // Don't toggle if clicking on action buttons
              if (event.target.dataset && event.target.dataset.action) {
                return;
              }
              const section = header.dataset.section;
              toggleSection(section);
            }
          });
        });
        
        // Update summaries when state changes
        function updateSummaries() {
          // Quote summary
          const quoteSummary = document.getElementById('quote-summary');
          if (quoteSummary && window.currentQuote?.text) {
            const text = window.currentQuote.text.substring(0, 50);
            quoteSummary.textContent = text + (window.currentQuote.text.length > 50 ? '...' : '');
          }
          
          // Media summary
          const mediaSummary = document.getElementById('media-summary');
          if (mediaSummary && window.selectedAsset) {
            const asset = window.selectedAsset;
            let summary = '';
            if (asset.provider === 'pexels') {
              summary = `Pexels ‚Ä¢ ${asset.query || 'Image'}`;
            } else if (asset.provider === 'ai') {
              summary = `AI ‚Ä¢ ${asset.query || 'Generated'}`;
            } else if (asset.provider === 'uploaded') {
              summary = 'Uploaded file';
            }
            mediaSummary.textContent = summary;
          }
          
          // Voice summary
          const voiceSummary = document.getElementById('voice-summary');
          if (voiceSummary && window.currentVoiceId) {
            const voiceSelect = document.getElementById('voiceover-voice');
            const selectedOption = voiceSelect?.selectedOptions[0];
            const voiceName = selectedOption?.text || window.currentVoiceId;
            voiceSummary.textContent = voiceName;
          }
        }
        
        // Hook into existing state updates
        const originalDisplayQuote = window.displayQuote;
        if (originalDisplayQuote) {
          window.displayQuote = function(quote) {
            originalDisplayQuote(quote);
            updateSummaries();
          };
        }
        
        // Mobile tab switching logic
        (function() {
          let activeMobileTab = null;
          
          // Check if we're on mobile
          function isMobile() {
            return window.matchMedia('(max-width: 768px)').matches;
          }
          
          // Function to switch to a specific tab (reuses existing accordion DOM)
          function switchToTab(section) {
            if (!isMobile()) return;
            
            // Map section names to tab IDs
            const tabIdMap = {
                'quote': 'mobile-tab-quote',
                'media': 'mobile-tab-background',
                'voice': 'mobile-tab-voiceover'
            };
            const tabButton = document.getElementById(tabIdMap[section]);
            const accordionBody = document.getElementById(`${section}-body`);
            const accordionHeader = document.querySelector(`[data-section="${section}"]`);
            const accordionIcon = accordionHeader?.querySelector('.accordion-icon');
            
            // If clicking the same tab, collapse it
            if (activeMobileTab === section) {
              activeMobileTab = null;
              if (tabButton) tabButton.classList.remove('active');
              if (accordionBody) accordionBody.classList.remove('active');
              if (accordionHeader) accordionHeader.classList.remove('active');
              if (accordionIcon) accordionIcon.textContent = '‚ñ∂';
              return;
            }
            
            // Close all other tabs and accordion bodies
            document.querySelectorAll('.mobile-studio-tab').forEach(tab => {
              tab.classList.remove('active');
            });
            document.querySelectorAll('.accordion-body').forEach(body => {
              body.classList.remove('active');
            });
            document.querySelectorAll('.accordion-header').forEach(header => {
              header.classList.remove('active');
              const icon = header.querySelector('.accordion-icon');
              if (icon) icon.textContent = '‚ñ∂';
            });
            
            // Open the selected tab
            activeMobileTab = section;
            if (tabButton) tabButton.classList.add('active');
            if (accordionBody) accordionBody.classList.add('active');
            if (accordionHeader) accordionHeader.classList.add('active');
            if (accordionIcon) accordionIcon.textContent = '‚ñº';
          }
          
          // Set up tab click handlers
          document.querySelectorAll('.mobile-studio-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
              e.preventDefault();
              const section = tab.dataset.section;
              switchToTab(section);
            });
          });
          
          // On mobile, make accordion headers call the same logic as tabs
          // (Note: accordion headers already skip their default behavior on mobile via the check above)
          // We add a separate listener that runs after the desktop check
          headers.forEach(header => {
            header.addEventListener('click', (event) => {
              if (!isMobile()) return; // Desktop behavior unchanged
              
              // Don't interfere with action buttons
              if (event.target.dataset && event.target.dataset.action) {
                return;
              }
              
              // Only handle if clicking the header itself
              if (event.target === header || event.target.closest('.accordion-header') === header) {
                const section = header.dataset.section;
                switchToTab(section);
              }
            });
          });
          
          // Initialize: open Quote tab by default on mobile
          if (isMobile()) {
            switchToTab('quote');
          }
          
          // Handle window resize to sync state
          let resizeTimeout;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
              if (!isMobile()) {
                // Reset mobile state when switching to desktop
                activeMobileTab = null;
                document.querySelectorAll('.mobile-studio-tab').forEach(tab => {
                  tab.classList.remove('active');
                });
              } else {
                // Initialize mobile state when switching to mobile
                if (!activeMobileTab) {
                  switchToTab('quote');
                }
              }
            }, 100);
          });
        })();
        
        // Update summaries on load
        setTimeout(updateSummaries, 1000);
        
        // Update preview height based on media selection
        function updatePreviewHeight() {
          const previewContainer = document.getElementById('live-preview-container');
          if (previewContainer) {
            if (window.selectedAsset) {
              previewContainer.classList.add('has-media');
            } else {
              previewContainer.classList.remove('has-media');
            }
          }
        }
        
        // Hook into asset selection to update preview height
        const originalAssetSelection = window.onAssetSelect;
        if (originalAssetSelection) {
          window.onAssetSelect = function(asset) {
            originalAssetSelection(asset);
            updatePreviewHeight();
          };
        }
        
        // Update preview height on load
        setTimeout(updatePreviewHeight, 1000);
        
        // Media buttons are now handled by ui-actions.js delegated event system
      })();
      
      // Debug helper for caption box visibility
      window.debugCaptionBox = function() {
        const stage = document.getElementById('stage');
        const box = stage?.querySelector('.caption-box');
        const container = document.getElementById('live-preview-container');
        const canvas = document.getElementById('live-preview-canvas');
        
        if (!stage) {
          console.warn('[debugCaptionBox] Stage not found');
          return;
        }
        
        if (!box) {
          console.warn('[debugCaptionBox] Caption box not found');
          return;
        }
        
        const stageRect = stage.getBoundingClientRect();
        const boxRect = box.getBoundingClientRect();
        const containerRect = container?.getBoundingClientRect();
        const canvasRect = canvas?.getBoundingClientRect();
        
        console.log('[debugCaptionBox] Stage:', {
          display: window.getComputedStyle(stage).display,
          visibility: window.getComputedStyle(stage).visibility,
          opacity: window.getComputedStyle(stage).opacity,
          rect: { width: stageRect.width, height: stageRect.height, top: stageRect.top, left: stageRect.left },
          clientWidth: stage.clientWidth,
          clientHeight: stage.clientHeight,
          offsetWidth: stage.offsetWidth,
          offsetHeight: stage.offsetHeight
        });
        
        console.log('[debugCaptionBox] Caption Box:', {
          display: window.getComputedStyle(box).display,
          visibility: window.getComputedStyle(box).visibility,
          opacity: window.getComputedStyle(box).opacity,
          position: window.getComputedStyle(box).position,
          zIndex: window.getComputedStyle(box).zIndex,
          rect: { width: boxRect.width, height: boxRect.height, top: boxRect.top, left: boxRect.left },
          styleLeft: box.style.left,
          styleTop: box.style.top,
          offsetWidth: box.offsetWidth,
          offsetHeight: box.offsetHeight,
          clientWidth: box.clientWidth,
          clientHeight: box.clientHeight
        });
        
        console.log('[debugCaptionBox] Container:', {
          display: container ? window.getComputedStyle(container).display : 'N/A',
          rect: containerRect ? { width: containerRect.width, height: containerRect.height } : 'N/A'
        });
        
        console.log('[debugCaptionBox] Canvas:', {
          display: canvas ? window.getComputedStyle(canvas).display : 'N/A',
          rect: canvasRect ? { width: canvasRect.width, height: canvasRect.height } : 'N/A',
          canvasWidth: canvas?.width,
          canvasHeight: canvas?.height
        });
      };
      
      // Debug helper for caption visibility diagnostics
      window.debugCaptionVisibility = function() {
        const container = document.getElementById('live-preview-container');
        const stage = document.getElementById('stage');
        const box = document.querySelector('.caption-box');
        return {
          container: container && {
            classes: container.className,
            styleOpacity: container.style.opacity,
            computedOpacity: getComputedStyle(container).opacity,
          },
          stage: stage && {
            styleDisplay: stage.style.display,
            computedDisplay: getComputedStyle(stage).display,
          },
          box: box && {
            rect: box.getBoundingClientRect(),
            visible: getComputedStyle(box).visibility,
          },
        };
      };
    </script>

    <!-- Render Status Banner -->
    <div id="render-status-banner" class="hidden fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50 bg-gray-900/90 dark:bg-gray-800/90 backdrop-blur-sm text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
        <svg id="render-status-spinner" class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span id="render-status-text" class="text-sm font-medium">Preparing video...</span>
    </div>

</body>
</html>
