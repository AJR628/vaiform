# alt=media Parameter Verification

**Date**: Final verification before enforcing alt=media requirement  
**Purpose**: Verify whether all URLs passed to /cdn include `alt=media` parameter

---

## URL Generation Analysis

### Backend URL Generators

**Finding**: ✅ **ALL BACKEND URL GENERATORS INCLUDE `alt=media`**

**Evidence**:

1. **`src/utils/storage.js:42`** - `uploadPublic()`:
   ```javascript
   const publicUrl = `https://firebasestorage.googleapis.com/v0/b/${bucket.name}/o/${encodeURIComponent(destPath)}?alt=media&token=${token}`;
   ```
   ✅ Always includes `?alt=media&token=...`

2. **`src/utils/storage.js:48-51`** - `buildPublicUrl()`:
   ```javascript
   const q = token ? `?alt=media&token=${encodeURIComponent(token)}` : `?alt=media`;
   return `https://firebasestorage.googleapis.com/v0/b/${bucket}/o/${encodedPath}${q}`;
   ```
   ✅ Always includes `?alt=media` (with or without token)

3. **`src/services/storage.service.js:29`** - `publicTokenUrl()`:
   ```javascript
   return `https://firebasestorage.googleapis.com/v0/b/${bucketName}/o/${encodeURIComponent(objectPath)}?alt=media&token=${token}`;
   ```
   ✅ Always includes `?alt=media&token=...`

### URL Sources in Frontend

**Call Sites**:
- `public/js/my-shorts.js:157` - `proxify(s.coverImageUrl || s.thumbUrl)`
- `public/creative.html:9988` - `proxify(url)` (AI-generated images)
- `public/creative.html:10045, 10052, 10056` - Background image proxying

**URL Sources**:
- `coverImageUrl` / `thumbUrl` come from:
  - `uploadPublic()` → always includes `alt=media` ✅
  - `buildPublicUrl()` → always includes `alt=media` ✅
  - Firestore documents (stored from `uploadPublic()` / `buildPublicUrl()`) ✅

**Conclusion**: All legitimate URLs generated by backend include `?alt=media`.

---

## Edge Cases & Legacy URLs

**Potential Edge Cases**:
1. **Legacy URLs** stored before `alt=media` was required (unlikely, but possible)
2. **Manual URL construction** (no evidence found)
3. **External URLs** passed to `/cdn` (should be blocked by hostname check)

**Risk Assessment**: **LOW** - All current URL generators include `alt=media`, but defensive approach is safer.

---

## Recommendation

**Use Soft Requirement** (warn if missing, but allow):

```javascript
// Soft-require alt=media (warn if missing, but allow - defensive approach)
if (urlObj.searchParams.get('alt') !== 'media') {
  console.warn('[cdn] URL missing alt=media parameter:', u.slice(0, 160));
  // Allow but warn - all legitimate URLs should include it, but don't break edge cases
}
```

**Rationale**:
- All legitimate URLs include it (verified)
- Soft requirement prevents breaking edge cases
- Warning logs help identify any URLs that don't include it
- Can be tightened to hard requirement later if logs show 100% compliance

---

**End of alt=media Verification**
